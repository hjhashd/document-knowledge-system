# OnlyOffice本地测试架构说明

## 整体架构图

```
浏览器/OnlyOffice编辑器
       ↓
    8888端口 (nginx统一入口)
       ↓
根据URL路径转发请求:
├── /files/ → 8080端口 (HTTP文件服务器)
├── /office/ → 8090端口 (OnlyOffice容器)
├── /onlyoffice-callback → 3000端口 (Next.js应用)
├── /api/upload → 3000端口 (Next.js应用)
└── 其他路径 → 3000端口 (Next.js应用)
```

## 各组件作用

### 1. Nginx (8888端口)
- **作用**: 反向代理服务器，统一入口点
- **为什么需要**: 
  - 只需暴露一个端口给外部
  - 根据URL路径智能分发请求到不同服务
  - 处理CORS和WebSocket等复杂配置

### 2. HTTP文件服务器 (8080端口)
- **作用**: 提供静态文件HTTP访问
- **为什么需要**:
  - OnlyOffice编辑器需要通过HTTP URL获取文件
  - 浏览器安全策略不允许直接访问本地文件系统
  - 提供CORS支持，允许OnlyOffice跨域访问文件

### 3. OnlyOffice容器 (8090端口)
- **作用**: 文档编辑服务
- **为什么需要**:
  - 提供文档编辑、协作功能
  - 需要独立的服务环境

### 4. Next.js应用 (3000端口)
- **作用**: 主应用程序
- **为什么需要**:
  - 提供用户界面
  - 处理文件上传和OnlyOffice回调

## 文件访问流程

1. 用户上传文件到Next.js应用
2. 文件保存到`public/upload`目录
3. 用户请求编辑文档
4. Next.js生成文件URL: `http://localhost:8888/files/文档名`
5. 请求到达nginx(8888端口)，根据`/files/`路径转发到8080端口
6. HTTP文件服务器(8080端口)读取`public/upload`目录中的文件并返回
7. OnlyOffice编辑器(8090端口)通过nginx获取文件并显示给用户

## 简化方案

如果您觉得这个架构太复杂，可以考虑以下简化方案：

### 方案1: 使用Next.js静态文件服务
- 移除8080端口的HTTP文件服务器
- 配置Next.js直接提供静态文件访问
- 修改nginx配置，将`/files/`请求直接转发到3000端口

### 方案2: 使用OnlyOffice内置文件服务器
- 配置OnlyOffice直接访问本地文件系统
- 需要修改OnlyOffice容器配置

## 启动命令

```bash
# 1. 启动OnlyOffice容器
docker run -d -p 8090:80 onlyoffice/documentserver

# 2. 启动HTTP文件服务器
cd d:\react_code\document-knowledge-system\public
npx http-server -p 8080 --cors

# 3. 启动Next.js应用
npm run dev

# 4. 启动nginx
nginx -c d:\react_code\document-knowledge-system\nginx.conf
```

## 访问地址

- 主应用: http://localhost:8888
- 文件访问: http://localhost:8888/files/文件名
- OnlyOffice编辑器: http://localhost:8888/office/